{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title|default:"Student Dashboard"}}{% endblock page_title %}
{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Stats Row -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info shadow-sm">
                    <div class="inner">
                        <h3>{{total_attendance}}</h3>
                        <p>Total Attendance</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success shadow-sm">
                    <div class="inner">
                        <h3>{{percent_present}}<sup style="font-size: 20px">%</sup></h3>
                        <p>Present</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger shadow-sm">
                    <div class="inner">
                        <h3>{{percent_absent}}<sup style="font-size: 20px">%</sup></h3>
                        <p>Absent</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-calendar-minus"></i>
                    </div>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-primary shadow-sm">
                    <div class="inner">
                        <h3>{{total_subject}}</h3>
                        <p>Subjects</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-book"></i>
                    </div>
                </div>
            </div>
            <!-- ./col -->
        </div>
        <!-- /.row -->
        
        <!-- Main Row: Notifications + Charts -->
        <div class="row mt-4">
            <!-- LEFT: NOTIFICATIONS -->
            <div class="col-md-6">
                <div class="card card-primary shadow" style="height: 100%;">
                    <div class="card-header bg-gradient-primary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-bell mr-2"></i>Recent Notifications
                            <span class="badge badge-danger badge-pill ml-2" id="unread-count">0</span>
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool text-white" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool text-white" onclick="markAllNotificationsRead()" title="Mark All Read">
                                <i class="fas fa-check-double"></i>
                            </button>
                            <button type="button" class="btn btn-tool text-white" onclick="refreshNotifications()" title="Refresh">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="notifications-container" class="notifications-list" style="height: 280px; overflow-y: auto;">
                            <div class="text-center p-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <p class="mt-3 text-muted">Loading notifications...</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-light py-3">
                        <div class="row text-center">
                            <div class="col-6 border-right">
                                <a href="#" onclick="refreshNotifications()" class="text-primary">
                                    <i class="fas fa-sync-alt mr-1"></i> Refresh
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="#" onclick="markAllNotificationsRead()" class="text-success">
                                    <i class="fas fa-check-double mr-1"></i> Mark All Read
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RIGHT: ATTENDANCE CHART -->
            <div class="col-md-6">
                <div class="card card-secondary shadow" style="height: 100%;">
                    <div class="card-header bg-gradient-secondary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-chart-pie mr-2"></i>Attendance Overview
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool text-white" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height: 250px;">
                            <canvas id="attendancePieChart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <span class="badge badge-success mr-3">
                                <i class="fas fa-square mr-1"></i> Present: {{percent_present}}%
                            </span>
                            <span class="badge badge-danger">
                                <i class="fas fa-square mr-1"></i> Absent: {{percent_absent}}%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.row -->
    </div>
</section>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function(){
    // Load notifications
    loadNotifications();
    
    // Attendance Pie Chart
    var pieData = {
        labels: ['Present', 'Absent'],
        datasets: [{
            data: [{{percent_present}}, {{percent_absent}}],
            backgroundColor: ['#28a745', '#dc3545'],
            borderWidth: 2
        }]
    };
    
    var pieChart = new Chart($('#attendancePieChart'), {
        type: 'doughnut',
        data: pieData,
        options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
    
    // Auto-refresh notifications
    setInterval(loadNotifications, 45000);
});

// ========== NOTIFICATION FUNCTIONS ==========
function loadNotifications() {
    $('#notifications-container').html(`
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading...</p>
        </div>
    `);
    
    $.ajax({
        url: '{% url "get_user_notifications_html" %}',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                $('#notifications-container').html(response.html);
                updateUnreadCount(response.unread_count);
            } else {
                showErrorState();
            }
        },
        error: function() {
            showErrorState();
        }
    });
}

function updateUnreadCount(count) {
    const badge = $('#unread-count');
    badge.text(count);
    count > 0 ? badge.show() : badge.hide();
}

function markNotificationRead(notificationId) {
    $.ajax({
        url: `/api/notifications/${notificationId}/read/`,
        type: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() },
        success: function() {
            loadNotifications();
        }
    });
}

function markAllNotificationsRead() {
    if (confirm('Mark all notifications as read?')) {
        $.ajax({
            url: '{% url "mark_all_notifications_read" %}',
            type: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            success: function() {
                loadNotifications();
            }
        });
    }
}

function refreshNotifications() {
    loadNotifications();
}

function showErrorState() {
    $('#notifications-container').html(`
        <div class="text-center p-4">
            <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
            <p class="text-danger">Failed to load notifications</p>
            <button class="btn btn-sm btn-outline-primary" onclick="loadNotifications()">
                <i class="fas fa-redo mr-1"></i> Retry
                            </button>
        </div>
    `);
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.cookie.match(/csrftoken=([^ ;]+)/)?.[1] || '';
}
</script>
<!-- Keep existing Firebase scripts -->
{% endblock custom_js %}