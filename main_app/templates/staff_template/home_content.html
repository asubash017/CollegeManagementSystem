{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title|default:"Staff Dashboard"}}{% endblock page_title %}
{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Small boxes (Stat box) -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info shadow-sm">
                    <div class="inner">
                        <h3>{{total_students}}</h3>
                        <p>Total Students</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <a href="#" class="small-box-footer">View Students <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success shadow-sm">
                    <div class="inner">
                        <h3>{{total_attendance}}</h3>
                        <p>Attendance Taken</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <a href="{% url 'staff_take_attendance' %}" class="small-box-footer">Take Attendance <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning shadow-sm">
                    <div class="inner">
                        <h3>{{total_leave}}</h3>
                        <p>Leave Applications</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <a href="{% url 'staff_apply_leave' %}" class="small-box-footer">Apply Leave <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-purple shadow-sm">
                    <div class="inner">
                        <h3>{{total_subject}}</h3>
                        <p>Subjects</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <a href="#" class="small-box-footer">View Subjects <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
        </div>
        <!-- /.row -->
        
        <!-- Main row: Notifications + Pie Chart -->
        <div class="row mt-4">
            <!-- LEFT COLUMN: NOTIFICATIONS DASHBOARD -->
            <div class="col-md-6">
                <div class="card card-primary shadow" style="height: 100%;">
                    <div class="card-header bg-gradient-primary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-bell mr-2"></i>Recent Notifications
                            <span class="badge badge-danger badge-pill ml-2" id="unread-count" style="font-size: 14px; padding: 5px 10px;">0</span>
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool text-white" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool text-white" onclick="markAllNotificationsRead()" title="Mark All Read">
                                <i class="fas fa-check-double"></i>
                            </button>
                            <button type="button" class="btn btn-tool text-white" onclick="refreshNotifications()" title="Refresh">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="notifications-container" class="notifications-list" style="height: 280px; overflow-y: auto;">
                            <!-- Loading state -->
                            <div class="text-center p-5">
                                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <p class="mt-3 text-muted">Loading your notifications...</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-light py-3">
                        <div class="row text-center">
                            <div class="col-6 border-right">
                                <a href="#" onclick="refreshNotifications()" class="text-primary">
                                    <i class="fas fa-sync-alt mr-1"></i> Refresh
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="#" onclick="markAllNotificationsRead()" class="text-success">
                                    <i class="fas fa-check-double mr-1"></i> Mark All Read
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RIGHT COLUMN: PIE CHART -->
            <div class="col-md-6">
                <div class="card card-secondary shadow" style="height: 100%;">
                    <div class="card-header bg-gradient-secondary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-chart-pie mr-2"></i>Activity Distribution
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool text-white" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool text-white" data-card-widget="remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height: 280px;">
                            <canvas id="pieChart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <span class="badge badge-success mr-3">
                                <i class="fas fa-square mr-1"></i> Attendance: {{total_attendance}}
                            </span>
                            <span class="badge badge-warning">
                                <i class="fas fa-square mr-1"></i> Leave: {{total_leave}}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.row (main row) -->
    </div><!-- /.container-fluid -->
</section>
{% endblock content %}

{% block custom_js %}
  <script>
      $(document).ready(function(){
        // Load notifications immediately
        loadNotifications();
        
        // Initialize pie chart with better styling
        var pieData = {
            labels: ['Attendance Taken', 'Leave Applications'],
            datasets: [{
                data: [{{total_attendance}}, {{total_leave}}],
                backgroundColor: ['#28a745', '#ffc107'],
                borderColor: ['#218838', '#e0a800'],
                borderWidth: 2,
                hoverOffset: 15
            }]
        };
        
        var pieOptions = {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        };
        
        var pieChartCanvas = $('#pieChart').get(0).getContext('2d');
        var pieChart = new Chart(pieChartCanvas, {
            type: 'doughnut',
            data: pieData,
            options: pieOptions
        });
        
        // Auto-refresh notifications every 45 seconds
        setInterval(loadNotifications, 45000);
      });

      // ========== ENHANCED NOTIFICATION FUNCTIONS ==========
      function loadNotifications() {
        $('#notifications-container').html(`
            <div class="text-center p-5">
                <div class="spinner-border text-primary" style="width: 2rem; height: 2rem;" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading...</p>
            </div>
        `);
        
        $.ajax({
            url: '{% url "get_user_notifications_html" %}',
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    $('#notifications-container').html(response.html);
                    updateUnreadCount(response.unread_count);
                    
                    // Add click handlers to new notifications
                    $('.notification-item').off('click').on('click', function() {
                        let notifId = $(this).data('id');
                        if (notifId) {
                            markNotificationRead(notifId);
                        }
                    });
                } else {
                    showErrorState('Failed to load notifications');
                }
            },
            error: function() {
                showErrorState('Network error. Please check connection.');
            }
        });
      }

      function updateUnreadCount(count) {
        const badge = $('#unread-count');
        badge.text(count);
        
        if (count > 0) {
            badge.show();
            badge.addClass('badge-danger').removeClass('badge-success');
            
            // Pulse animation for new notifications
            if (count > parseInt(badge.data('prev-count') || 0)) {
                badge.addClass('animate-pulse');
                setTimeout(() => badge.removeClass('animate-pulse'), 2000);
            }
        } else {
            badge.hide();
        }
        badge.data('prev-count', count);
      }

      function markNotificationRead(notificationId) {
        $.ajax({
            url: `/api/notifications/${notificationId}/read/`,
            type: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            success: function(response) {
                if (response.success) {
                    // Visual feedback
                    $(`[data-id="${notificationId}"]`).addClass('read-notification');
                    loadNotifications(); // Refresh list
                }
            }
        });
      }

      function markAllNotificationsRead() {
        if (!$('#unread-count').is(':visible')) {
            if (typeof toastr !== 'undefined') {
                toastr.info('No unread notifications');
            }
            return;
        }
        
        if (confirm('Mark all notifications as read?')) {
            $.ajax({
                url: '{% url "mark_all_notifications_read" %}',
                type: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken() },
                success: function(response) {
                    if (response.success) {
                        loadNotifications();
                        if (typeof toastr !== 'undefined') {
                            toastr.success(`âœ“ ${response.marked_count} notifications marked as read`);
                        }
                    }
                }
            });
        }
      }

      function refreshNotifications() {
        loadNotifications();
        if (typeof toastr !== 'undefined') {
            toastr.info('Notifications refreshed', '', {timeOut: 1000});
        }
      }

      function showErrorState(message) {
        $('#notifications-container').html(`
            <div class="text-center p-5">
                <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                <p class="text-danger font-weight-bold">${message}</p>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadNotifications()">
                    <i class="fas fa-redo mr-1"></i> Try Again
                </button>
            </div>
        `);
      }

      function getCSRFToken() {
        return $('meta[name="csrf-token"]').attr('content') || 
               $('[name=csrfmiddlewaretoken]').val() ||
               document.cookie.match(/csrftoken=([^ ;]+)/)?.[1] || '';
      }

      // Add CSS for animations
      $('<style>').text(`
          .animate-pulse {
              animation: pulse 1.5s infinite;
          }
          @keyframes pulse {
              0% { transform: scale(1); }
              50% { transform: scale(1.1); }
              100% { transform: scale(1); }
          }
          .read-notification {
              opacity: 0.6;
              background-color: #f8f9fa !important;
          }
          .notification-item {
              transition: all 0.2s ease;
              border-left: 4px solid transparent;
          }
          .notification-item:hover {
              transform: translateX(5px);
              background-color: #f8f9fa;
          }
          .notification-item.unread {
              border-left-color: #007bff;
          }
          .badge-pill {
              border-radius: 10rem;
          }
      `).appendTo('head');

  </script>
  <!-- Keep your existing Firebase scripts below -->
{% endblock custom_js %}