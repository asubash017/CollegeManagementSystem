{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{ page_title }}{% endblock page_title %}

{% block custom_css %}
<style>
    .id-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .id-card {
        border-radius: 12px;
        background: #fff;
        border: 1px solid #dee2e6;
        padding: 1rem;
        min-height: 380px;
        display: flex;
        flex-direction: column;
        font-family: Arial, sans-serif;
        position: relative;
    }

    .id-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 0.5rem;
        margin-bottom: 0.7rem;
    }

    .id-card-header h5 {
        font-size: 0.95rem;
        margin: 0;
        line-height: 1.2;
        text-transform: uppercase;
    }

    .id-card-header img {
        width: 48px;
        height: 48px;
        object-fit: contain;
    }

    .id-card-body {
        display: flex;
        gap: 1rem;
        flex: 1;
    }

    .id-card-photo {
        width: 90px;
        height: 110px;
        flex-shrink: 0;
    }

    .id-card-photo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 6px;
        border: 2px solid #ced4da;
    }

    .id-card-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .id-card-info h4 {
        font-size: 1rem;
        margin: 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .id-card-info p {
        font-size: 0.85rem;
        margin: 2px 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .id-card-qr {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        width: 70px;
        height: 70px;
    }

    .id-card-footer {
        border-top: 1px solid #e9ecef;
        font-size: 0.8rem;
        color: #495057;
        padding-top: 0.4rem;
        margin-top: 0.5rem;
    }

    .print-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    @media print {
        body { background: #fff; }
        .main-header, .main-sidebar, .print-actions, .content-header, footer { display: none !important; }
        .content-wrapper { margin-left: 0 !important; }
        .id-card-grid { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .id-card { page-break-inside: avoid; break-inside: avoid; border-color: #adb5bd; }
    }
</style>
{% endblock custom_css %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="card card-outline card-primary mb-3">
            <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
                <div class="mb-2">
                    <h5 class="mb-1 text-primary">{{ meta.role }} | {{ meta.mode }} generation</h5>
                    <p class="mb-0 text-muted">
                        {{ meta.filter_summary }} &middot;
                        Total Cards: {{ meta.total }} &middot;
                        Generated: {{ meta.generated_on }}
                    </p>
                </div>
                <div class="print-actions mb-2">
                    <a href="{% url 'id_card_generator' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left mr-1"></i>Back to generator
                    </a>
                    <button type="button" onclick="window.print()" class="btn btn-primary btn-sm">
                        <i class="fas fa-print mr-1"></i>Print / Save as PDF
                    </button>
                </div>
            </div>
        </div>

        <div class="id-card-grid">
            {% for card in cards %}
            <div class="id-card shadow-sm">
                <div class="id-card-header">
                    <div>
                        <h5>{{ card.institution }}</h5>
                        <small class="text-muted">{{ card.role }}</small>
                    </div>
                    <img src="{% static 'dist/img/cmsl.png' %}" alt="Institution Logo">
                </div>

                <div class="id-card-body">
                    <div class="id-card-photo">
                        <img src="{{ card.profile_pic }}" alt="{{ card.full_name }}">
                    </div>

                    <div class="id-card-info">
                        <div>
                            <h4>{{ card.full_name }}</h4>
                            {% if card.role == "Student" %}
                                <p><strong>Reg No:</strong> {{ card.id_code }}</p>
                                <p><strong>Course:</strong> {{ card.course }}</p>
                                <p><strong>Session:</strong> {{ card.session }}</p>
                            {% else %}
                                <p><strong>Staff ID:</strong> {{ card.id_code }}</p>
                            {% endif %}
                            <p><strong>Email:</strong> {{ card.email }}</p>
                            <p><strong>Gender:</strong> {{ card.gender }}</p>
                            {% if card.address %}
                                <p><strong>Address:</strong> {{ card.address }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <img src="{{ card.qr_code }}" class="id-card-qr" alt="QR Code">

                <div class="id-card-footer">
                    Issued on {{ card.issued_on }}
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <p class="text-center text-muted mb-0">No cards available.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endblock content %}
